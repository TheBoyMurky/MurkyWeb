FROM alpine:3

# Defining ENVs
ENV TOR_RELAY_NICKNAME=""
ENV TOR_RELAY_CONTACT_INFO=""
ENV TOR_RELAY_ORPORT="9001"

# Create a non-root user
RUN addgroup toruser
RUN adduser -G toruser -S toruser

# Install Packages
RUN apk update
RUN apk upgrade
RUN apk add tor nyx

# Add permissions to toruser
RUN \
    chown -R toruser:toruser /var/lib/tor && \
    chown -R toruser:toruser /var/log/tor && \
    chown -R toruser:toruser /etc/tor

# Update torrc
RUN mv /etc/tor/torrc.sample /etc/tor/torrc
RUN /bin/sh -c '\
  [ -n "$TOR_RELAY_NICKNAME" ] && sed -i "s|^#Nickname .*|Nickname $TOR_RELAY_NICKNAME|" /etc/tor/torrc; \
  [ -n "$TOR_RELAY_CONTACT_INFO" ] && sed -i "s|^#ContactInfo .*|ContactInfo $TOR_RELAY_CONTACT_INFO|" /etc/tor/torrc; \
  /sed -i "s|^#ORPort .*|ORPort $TOR_RELAY_ORPORT|" /etc/tor/torrc; \
  sed -i "s|^#SOCKSPort .*|SOCKSPort 0|" /etc/tor/torrc; \
  sed -i "s|^#ExitRelay .*|ExitRelay 0|" /etc/tor/torrc; \
  sed -i "s|^#ControlPort .*|ControlPort 9051|" /etc/tor/torrc; \
  sed -i "s|^#CookieAuthentication .*|CookieAuthentication 1|" /etc/tor/torrc'


# Expose ORPort
EXPOSE ${TOR_RELAY_ORPORT}

# Update to non-root user
USER toruser

# Entrypoint
ENTRYPOINT ["/bin/sh", "-c", "tor & sleep 5 && exec nyx"]